{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WCBZJQFX');</script>
    <!-- End Google Tag Manager -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Intake Form</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/css/style.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <meta name="csrf-token" content="{{ csrf_token }}">
    

    
    <!-- <style>
        #documentStatusBanner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-family: 'Poppins', sans-serif;
            min-height: 60px;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            padding: 20px;
            margin: 0;
            border-radius: 0;
            text-align: center;
            border: none;
            width: 100%;
        }
        
        #documentStatusBanner.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #c3e6cb;
            color: #155724;
        }
        
        #documentStatusBanner.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ffeaa7;
            color: #856404;
        }
        
        #documentStatusBanner #statusTitle {
            font-weight: 600;
            margin-bottom: 8px;
            margin-top: 0;
        }
        
        #documentStatusBanner #statusMessage {
            font-weight: 400;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        #documentStatusBanner .container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        #documentStatusBanner .btn-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: inherit;
            opacity: 0.5;
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1;
        }
        
        #documentStatusBanner .btn-close:hover {
            opacity: 1;
        }
    </style> -->

    <style>
    #spinnerOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    }

    .spinner {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #4a90e2;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    }

    @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
    }

    </style>
</head>
   

    <body>
    <!-- Success/Decline Message Banner -->
    <!-- <div id="documentStatusBanner" style="display: none;">
        <div class="container">
            <h4 id="statusTitle"></h4>
            <p id="statusMessage"></p>
            <button type="button" class="btn-close" aria-label="Close">&times;</button>
        </div>
    </div> -->

          <!-- <nav class="navbar">
        <div class="nav-content">
            <a href="#" class="logo px-4">Logo Here</a>
            <div class="nav-links">
                <a href="#about">About</a>
                <a href="#cases">Cases</a>
                <a href="#resources">Resources</a>
                <a href="#contact">Contact</a>
            </div>
        </div>
    </nav> -->

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WCBZJQFX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <section class="hero">
      
        <a href="" class="logo  d-flex justify-content-left">
            <img src="{% static 'img/theme.svg' %}" alt="Logo">
            <!-- <img src="../static/img/theme.svg" alt="Logo" > -->
        </a>
        <div class="hero-content">
              

            <h1>Roblox & Adult Predators: A Must-Know Warning</h1>
            <div class="separator"></div>
            <!-- <p>Roblox, the world's largest user-generated gaming platform "designed for children," attracts 78 million daily visitors</p> -->

            <div class="sub-heading"> Has your child had a troubling encounter with an adult on Roblox? If yes, we’re here to help. Just follow 3 simple steps:</div>
           
            <div class="step-wrapper">
                <div class="steps">
                    <div class="step-icon">
                        <img src="{% static 'img/icon-prequalify.svg' %}" alt="Prequalify">
                    </div>
                    <div>
                        <small class="pt-2 pb-1">Step 1</small>
                        <h4>Prequalify</h4>
                        <p>Briefly explain what happened during the troubling Roblox encounter.</p>
                    </div>
                </div>
                <div class="steps">
                    <div class="step-icon">
                        <img src="{% static 'img/icon-retainer.svg' %}" alt="Prequalify">
                    </div>
                    <div>
                        <small class="pt-2 pb-1">Step 2</small>
                        <h4>Retainer</h4>
                        <p>We’ll provide a simple agreement so we can move forward.</p>
                    </div>
                </div>
                <div class="steps">
                    <div class="step-icon">
                        <img src="{% static 'img/icon-intake.svg' %}" alt="Prequalify">
                    </div>
                    <div>
                        <small class="pt-2 pb-1">Step 3</small>
                        <h4>Intake</h4>
                        <p>Complete a quick intake form to understand how we can best help.</p>
                    </div>
                </div>
                
            </div>
            <div class="row mt-4" id="fixBtnRow">
                <div class=" d-flex justify-content-center">
                    <!-- <button class="btn px-5 mx-3" id="openModal" >Yes</button> -->
                    <button class="home-btn" id="openModal" >Check Prequalification</button>
                </div>
            </div>

        </div>
    </section>

    <!-- <main class="main-content">
        <div class="content-grid">
            <div class="content-card">
                <div class="card-icon"><img src="{% static 'img/icon-expertise1.svg' %}" alt="Case Evaluation"></div>
                <div>
                    <h3>Class Action Expertise</h3>
                    <p>Specialized representation for group litigation matters, ensuring collective justice and fair compensation.</p>
                </div>
            </div>
            <div class="content-card">
                <div class="card-icon"><img src="{% static 'img/icon-expertise2.svg' %}" alt="Case Evaluation"></div>
                <div>
                    <h3>Case Evaluation</h3>
                    <p>Thorough analysis of legal claims to determine optimal strategies for successful resolution.</p>
                </div>
            </div>
            <div class="content-card">
                <div class="card-icon"><img src="{% static 'img/icon-expertise3.svg' %}" alt="Case Evaluation"></div>
                <div>
                    <h3>Client Advocacy</h3>
                    <p>Dedicated protection of client interests through aggressive litigation and negotiation tactics.</p>
                </div>
            </div>
        </div>
    </main> -->
    <div class="section-content primary-color">
        <div class="row px-4 py-5">
            <div class="col-12 col-md-4 text-center pb-4 pb-md-0">
                <!-- <img src="{% static 'img/Roblox-sec1.png' %}" alt="Roblox Image"> -->
                <img src="{% static 'img/Roblox-sec1.png' %}" alt="Roblox Image">
            </div>
            <div class="col-12 col-md-8 d-flex flex-column justify-content-center">
                <h4>  Is Roblox Putting Children at Risk of Predators? </h4>
                <p>Many parents trust Roblox to be a safe gaming platform for their children, but mounting lawsuits suggest otherwise. Despite promising child protection, Roblox faces serious allegations of failing to stop predators from targeting kids on its platform.</p>
                <h4>What You Should Know</h4>
                <ul>
                    <li>In 2023, Roblox reported 13,000+ sextortion cases to child safety authorities.</li>
                    <li>In early 2024, law enforcement requests jumped 33% - predators are still active.</li>
                    <li>Chat features, avatars, and hidden games are being used to manipulate children.</li>
                    <li>Kids as young as six have encountered virtual strip clubs and explicit content.</li>
                    <li>Lawsuits allege Roblox is not doing enough to monitor or block bad actors.</li>
                    <li>Many parents believe it’s a safe space - but harmful content continues to slip through.</li>
                </ul>
                <h4 class="mb-0">This isn’t just a game - it’s a serious risk to children’s safety.</h4>
      
            </div>
</div>
    </div>
    <div class="section-safeguard secondary-color1">
        <div class="row px-4 py-5">
             
        <div class="col-12 col-md-8 bg-light-opacity d-flex flex-column justify-content-center">
            <h4>Doesn’t Roblox Have Safeguards in Place?</h4>
            <p>Roblox says it uses AI filters and 3,000 human moderators to monitor up to 50,000 private chats per second - all to keep kids safe.</p>
            <h4>But Critics Say These Protections Are Failing</h4>
            <ul>
                <li>Independent researcher Ben Simon (aka Ruben Sim) has exposed major moderation flaws.</li>
                <li>Harmless messages get flagged, while predatory chats go unchecked.</li>
                <li>TikTok, with 3x Roblox’s users, employs 40,000 moderators — 10x more than Roblox.</li>
                <li>Roblox, critics argue, spends more effort marketing safety than ensuring it.</li>
            </ul>
            <p class="text-italic mb-0"> “Roblox puts more time into convincing parents their platform is safe than actually protecting children.”</p>
            <p><span class="bold">- Ben Simon</span>  |  <span class="small"> who urged Roblox to ban a convicted pedophile </span></p>
            <h4>Roblox’s moderation may not be enough - and your child may not be as safe as you think.</h4>
            
                </div>    
                 <div class=" col-12 col-md-4 text-center ">
                    <!-- <img src="{% static 'img/Roblox-md-3.jpeg' %}"> -->
                    <img src="{% static 'img/Roblox-md-3.jpeg' %}" alt="Roblox Safeguards Image">
                 </div>    
</div>
    </div>

    <div class="section-Lawsuit py-5">
        <div class="row px-4">
            <div class="col-12">
                <h4>What Is the Roblox Sexual Abuse Lawsuit About?</h4>
                <p>Parents across the U.S. are filing lawsuits against Roblox, accusing the company of failing to protect children from sexual exploitation and financial abuse. These legal actions argue that the platform’s safeguards are inadequate, and children are paying the price.</p>
                <div class="d-block d-md-flex justify-content-between">
                    <div class=" lawsuit-box">
                        <h4>Key Allegations</h4>
                        <ul>
                            <li>Lawsuit filed in Oct 2022</li>
                            <li>Class-action claims Roblox exploits kids</li>
                            <li>Weak controls enable adult content, grooming, and overspending</li>
                        </ul>
                    </div>
                    <div class="lawsuit-box mb-0">
                        <h4>Why It Matters</h4>
                        <ul>
                            <li>Shows systemic failure in safety</li>
                            <li>Trusted platform exposing children</li>
                            <li>Parents unaware of real dangers</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- <div class="col-12 col-md-6 text-center"> -->
 <!-- <img src="{% static 'img/Roblox-md-2.jpeg' %}"> -->
            <!-- </div> -->
        </div>

    </div>

    <div class="disclaimer py-4">
        <div class="row">
            <div class="col-12">
        
               <p><strong>DISCLAIMER:</strong> The hiring of a lawyer is an important decision that should not be based solely on advertisements. The material contained on <a href="https://nextkeylitigation.com" target="_blank">nextkeylitigation.com</a> is for general informational purposes only and does not constitute legal advice. Our list of participating law firms is licensed to practice law only in the following states: Mississippi, Arkansas, Illinois, Florida, and Georgia.</p>

                     <p class="mb-0"> © 2025 All rights reserved. NextKey Litigation.</p>
            </div>
        </div>
        
        

    </div>
    <footer class="footer text-secondary">
        <div class="d-block d-md-flex justify-content-between align-items-center px-3 py-2">

            <div>
                <a href="{% url 'about_us' %}" class="text-secondary">About Us</a> |
                <a href="{% url 'consent_box' %}" class="text-secondary">Consent Box</a> |
                <a href="{% url 'disclaimer' %}" class="text-secondary">Disclaimer</a> |
                <a href="{% url 'participating_firms' %}" class="text-secondary">Participating Firms</a> |
                <a href="{% url 'privacy_policy' %}" class="text-secondary">Privacy Policy</a> |
                <a href="{% url 'terms_of_service' %}" class="text-secondary">Terms of Service</a> |


                
            </div>
            <div class="d-flex align-items-center gap-2">
                <span>Follow us on:</span>
                <a href="https://facebook.com" target="_blank" class="text-secondary">
                    <img src="{% static 'img/facebook.png' %}" alt="Facebook" width="20" />
                </a>
                <a href="https://instagram.com" target="_blank" class="text-secondary">
                    <img src="{% static 'img/insta.png' %}" alt="Instagram" width="20" />
                </a>
            </div>
        </div>
    </footer>



    <!-- modal popup code -->
      <div class="modal-overlay" id="modal">
        <div class="modal-content scroll">
            <div class="row justify-content-end">
                <button class="col-12 close-modal" onclick="closeModal()">&times;</button>
            </div>
            <!-- Screen 1 -->
            <div class="form-screen active px-3" id="screen1">
                <h4 class="model-title">Tell Us What Happened</h4>
               <div class="input-group">
                    <label>What best describes the troubling actions?</label>
                    <select id="question_3" class="question-dropdown" data-question-text="What best describes the troubling actions?"></select>
                </div>

                <div class="input-group">
                    <label>Did the child and predator first meet on Roblox?</label>
                    <select id="question_4" class="question-dropdown" data-question-text="Did the child and predator first meet on Roblox?"></select>
                </div>
                <div class="input-group">
                     <label>Within the last 5 weeks, how many hours per day is spent playing Minecraft, Call Of Duty, Fortnite, Roblox or Grand Theft Auto? *</label>
                    <select id="question_5" class="question-dropdown" data-question-text="Within the last 5 weeks, how many hours per day is spent playing Minecraft, Call Of Duty, Fortnite, Roblox or Grand Theft Auto? *"></select>

                </div>
                <div class="input-group">
                    <label> What harm has the gamer suffered from? *</label>
                    <select id="question_6" class="question-dropdown" data-question-text="What harm has the gamer suffered from? *"></select>
                </div>
                <div class="input-group">
                    <label>What treatment was received as a result of playing video games? *</label>
                    <select id="question_7" class="question-dropdown" data-question-text="What treatment was received as a result of playing video games? *"></select>

                </div>
                <div class="mt-3">
                    <label>Date of Birth of gamer? *</label>
                    <input type="text" id="gamer_dob" class="form-control" placeholder="MM-DD-YYYY">
                </div>

                 <div class="form-footer">
                    <!-- <button type="button" class="btn-blue" onclick="showScreen(2)">Next</button> -->
                    <button type="button" class="btn-blue" onclick="validateScreen1()">Next</button>
                </div>
            </div>
            <!-- Screen 2 -->
           <div class="form-screen px-3" id="screen2"> 
                <div class="input-group">
                    <label>First Name *</label>
                    <input type="text" id="first_name" placeholder="John" required>
                </div>
                <div class="input-group">
                    <label>Last Name *</label>
                    <input type="text" id="last_name" placeholder="Smith" required>
                </div>
                <div class="input-group">
                    <label>Cell Phone *</label>
                    <input type="tel" id="cell_phone" placeholder="123-456-7890" required>
                </div>
                <div class="input-group">
                    <label>Email *</label>
                    <input type="email" id="email" placeholder="example@domain.com" required>
                </div>
                <div class="input-group">
                    <label>Zip Code *</label>
                    <input type="text" id="zipcode" placeholder="12345" maxlength="5" required>
                </div>
                <div class="input-group">
                    <label for="working_with_attorney">Are you currently working with an attorney for gaming sex abuse claim? *</label>
                    <select id="working_with_attorney" required>
                        <option value="">Select</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Additional Notes (optional)</label>
                    <input type="text" id="additional_notes" placeholder="Any additional details">
                </div>

                <!-- Consent Box Label & Instructions -->
                <!-- <label>Please read the
                    <strong>
                        <a href="#" id="showConsentModal">Consent box</a>
                    </strong> before making a choice.
                </label> -->

                <!-- <small id="consent-hint" style="color:gray;">
                    Please read the consent box before making a choice.
                </small> -->

                    <p>
                        Please read the <button class="consentBtn" onclick="showConsentModal()">Consent Box</button> before making a choice.
                    </p>


                <!-- Checkboxes -->
                <div class="input-group d-flex">
                    <label class="cb-label me-4">
                        <input type="checkbox" id="agreecheck" name="agreement_status" value="agree" disabled> Yes, I Agree and Consent
                    </label>
                    <label class="cb-label me-4">
                        <input type="checkbox" id="notAgreecheck" name="agreement_status" value="not_agree" disabled> No, I don't agree 
                    </label>
                </div>

           
               


                <div class="form-footer ">
                    <button type="button" class="btn-blue-outline" onclick="showScreen(1)">Back</button>
                    <button type="button" class="btn-blue" onclick="submitForm()">Submit</button>
                    <!-- <button class="btn-blue" onclick="showCongrats()">Submit</button> -->
                </div>
            </div>



    

        </div>
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

        <!-- <form style="display: none;">
            {% csrf_token %}
        </form> -->
    </div>

    <!-- Spinner Overlay -->
    <div id="spinnerOverlay" style="display: none; flex-direction: column; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.8); z-index: 9999;">
        <div class="spinner"></div>
        <div id="spinnerMessage" style="margin-top: 20px; font-size: 18px; color: #333; text-align: center;">
        Your document is being prepared. Just 2 steps to finish your Roblox claim.
    </div>
</div>





    
<div id="customModal" class="modal">
  <div class="modal-content">
    <img id="modalIcon" class="icon" src="" alt="icon" />
    <p id="modalMessage"></p>
    <!-- <span class="close-btn" onclick="closeCustomModal()">&times;</span> -->
    <button class="btn-blue" onclick="closeCustomModal()">OK</button>
  </div>
</div>


<!-- Consent Modal -->
<div class="modal fade" id="consentModal" tabindex="-1" aria-labelledby="consentModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="consentModalLabel">NEXTKEY LITIGATION CONSENT BOX</h5>
                <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
            </div>

            <div class="modal-body">
                By checking the box below that says <strong>"Yes, I Agree and Consent"</strong> and clicking the <strong>"Submit"</strong> button, I represent that I am 18+ years of age and have read and agreed to the NextKey Litigation’s <a href="{% url 'terms_of_service' %}" target="_blank">Terms of Service</a> and <a href="{% url 'privacy_policy' %}" target="_blank">Privacy Policy</a>. I consent to the transfer of information that I provide on this site to third-party legal service providers and non-legal service providers, third party partners and their affiliates and service providers; I agree to be contacted with marketing by email & telephone, which may include artificial or pre-recorded calls and/or SMS text messages, delivered via automated technology, to the email and phone number that I have provided. I understand that my consent is not a condition of receipt of services.
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-blue" data-bs-dismiss="modal">Close</button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
    // Read CSRF token from the meta tag and add it to every AJAX request
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

    
    const csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });


    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

   function showConsentModal() {
    var modal = new bootstrap.Modal(document.getElementById('consentModal'));
    modal.show();
}

    // When consent modal is closed → enable the checkboxes
    document.getElementById('consentModal').addEventListener('hidden.bs.modal', function () {
        const agreeCheck = document.getElementById("agreecheck");
        const notAgreeCheck = document.getElementById("notAgreecheck");

        // Enable both checkboxes
        agreeCheck.disabled = false;
        notAgreeCheck.disabled = false;

        // Make them mutually exclusive
        agreeCheck.addEventListener("change", function () {
            if (this.checked) {
                notAgreeCheck.checked = false;
            }
        });
        notAgreeCheck.addEventListener("change", function () {
            if (this.checked) {
                agreeCheck.checked = false;
            }
        });
    });


    function hideConsentModal() {
        var modal = bootstrap.Modal.getInstance(document.getElementById('consentModal'));
        if (modal) {
            modal.hide();
        }
    }

    document.getElementById('openModal').addEventListener('click', () => {
        document.getElementById('modal').style.display = 'flex';
    });

    function validatePhone(number, region) {
    try {
        const phone = libphonenumber.parsePhoneNumber(number, region);
        return phone.isValid();
    } catch (e) {
        return false;
    }
}


    // Modal Control
    // document.getElementById('openModal2').addEventListener('click', () => {
    //     document.getElementById('modal').style.display = 'block';
    // });

    const modalBtn2 = document.getElementById('openModal2');
    if (modalBtn2) {
        modalBtn2.addEventListener('click', () => {
            document.getElementById('modal').style.display = 'block';
        });
    }
    function showScreen(screenNumber) {
        document.querySelectorAll('.form-screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(`screen${screenNumber}`).classList.add('active');
    }

    // ------------------------------
    // Show m-d-Y to the user, submit/store as Y-m-d.
    // maxDate prevents future dates.
    flatpickr("#gamer_dob", {
        altInput: true,
        altFormat: "m-d-Y",   // what the user sees
        dateFormat: "Y-m-d",  // what .val() returns
        maxDate: "today",
        allowInput: true,
        onChange: function(selectedDates, dateStr, instance) {
            // Remove error border when a valid date is selected
            const altInput = instance.altInput;
            if (dateStr) {
            altInput.classList.remove("error-border");
            }
        }
    });

    // const dobInput = document.getElementById('gamer_dob');

    // dobInput.addEventListener('input', function (e) {
    //     const raw = this.value.replace(/\D/g, ''); // remove non-digits
    //     if (raw.length === 8) {
    //         const mm = raw.slice(0, 2);
    //         const dd = raw.slice(2, 4);
    //         const yyyy = raw.slice(4);
    //         const formatted = `${mm}-${dd}-${yyyy}`;

    //         // Set formatted value for user to see
    //         this._flatpickr.setDate(`${yyyy}-${mm}-${dd}`, true); // true = trigger change event
    //     }
    // });


    function parseDobString(d) {
        if (!d) return null;

        // ISO: 1998-07-30
        if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
            return new Date(d + "T00:00:00");
        }

        // US: 07-30-1998
        if (/^\d{2}-\d{2}-\d{4}$/.test(d)) {
            const [mm, dd, yyyy] = d.split("-");
            return new Date(`${yyyy}-${mm}-${dd}T00:00:00`);
        }

        return null;
    }

    function calcAge(dob) {
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
        return age;
    }
    // ------------------------------

    // function isValidEmail(email) {
    //     // basic RFC-ish check
    //     return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    // }

    // // Open consent box popup
    // document.getElementById("showConsentModal").addEventListener("click", function (e) {
    //     e.preventDefault();
    //     window.consentWindow = window.open(
    //         "/consent-box",
    //         "ConsentWindow",
    //         "width=800,height=600"
    //     );
    // });

    // Listen for message from consent box window
    window.addEventListener("message", function (event) {
        if (event.data && event.data.allowAgreement) {
            const agreeCheck = document.getElementById("agreecheck");
            const notAgreeCheck = document.getElementById("notAgreecheck");

            // Enable both checkboxes
            agreeCheck.disabled = false;
            notAgreeCheck.disabled = false;

            // Make them mutually exclusive
            agreeCheck.addEventListener("change", function () {
                if (this.checked) {
                    notAgreeCheck.checked = false;
                }
            });

            notAgreeCheck.addEventListener("change", function () {
                if (this.checked) {
                    agreeCheck.checked = false;
                }
            });
        }
    });


    function submitForm() {

        let isValid = true;

        // Reset error borders
        $('#screen2 input, #screen2 select').removeClass('error-border');

        const first_name = $("#first_name").val().trim();
        const last_name = $("#last_name").val().trim();
        const cell_phone = $("#cell_phone").val().trim();
        const email = $("#email").val().trim();
        const zipcode = $("#zipcode").val().trim();
        const working_with_attorney = $("#working_with_attorney").val();
        const gamer_dob = $("#gamer_dob").val();
        // const consent = $("#consent_checkbox").is(":checked");

        // Get all checked agreement checkboxes
        const checkedAgreements = $("input[name='agreement_status']:checked");
        if (checkedAgreements.length !== 1) {
            $("input[name='agreement_status']").addClass("error-border");
            isValid = false;
        } else {
            agreement_status = checkedAgreements.val(); // will be "agree" or "not_agree"
        }

        const additional_notes = $("#additional_notes").val().trim();

          // Required field check
        if (!first_name) {
            $("#first_name").addClass("error-border");
            isValid = false;
        }
        if (!last_name) {
            $("#last_name").addClass("error-border");
            isValid = false;
        }

        // ✅ Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailRegex.test(email)) {
            $("#email").addClass("error-border");
            isValid = false;
        }

        // ✅ US Cell Phone validation (e.g., (123) 456-7890 or 123-456-7890)
        const phoneRegex = /^(\(\d{3}\)\s*|\d{3}[-.\s]?)\d{3}[-.\s]?\d{4}$/;
        if (!cell_phone || !phoneRegex.test(cell_phone)) {
            $("#cell_phone").addClass("error-border");
            isValid = false;
        }

        // ✅ US Zip Code validation (5-digit or ZIP+4)
        const zipRegex = /^\d{5}(-\d{4})?$/;
        if (!zipcode || !zipRegex.test(zipcode)) {
            $("#zipcode").addClass("error-border");
            isValid = false;
        }

        if (!working_with_attorney) {
            $("#working_with_attorney").addClass("error-border");
            isValid = false;
        }

   
        // if (!consent) {
        //     $("#agreement_status").addClass("error-border");
        //     isValid = false;
        // }

        
        // Block submission if any errors
        if (!isValid) return;

        // const age = calcAge(dob);
        // if (age > 20) {
        //     showModal("Age of gamer is more than 20, so you're not eligible.");
        //     return;
        // }

    //     if (working_with_attorney === "yes") {
    //     showModal("You are currently working with an attorney for a gaming sex abuse claim, so you're not eligible.","error");
    //     return;
    // }



        // ✅ Step 1: Submit user details
        $.ajax({
            url: "/api/user-details/",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                first_name,
                last_name,
                cell_phone,
                email,
                zipcode,
                working_with_attorney,

                gamer_dob,
                additional_notes,
                agreement_status
            }),
            success: function (response) {
                const userId = response.id;
                
                // Store userId globally for document creation during this session
                window.currentUserId = userId;
                
                // Build redirect URL now that we have userId
                const redirectUrl = `/intake-form/${userId}/?prequalified=true`;

                //  submitAnswers(userId, function () {
                //     showModal("All submitted!", "success");
                //     window.location.href = redirectUrl;  // 🔁 Redirect here
                // });

                // ✅ Step 2: Store guardian names for form prefilling (still needed for forms.html)
                sessionStorage.setItem("guardian_first_name", first_name);
                sessionStorage.setItem("guardian_last_name", last_name);

                // ✅ Step 3: Determine eligibility from DOB
                const dobValue = $("#gamer_dob").val()?.trim();
                // if (!dobValue) {
                //     alert("Please enter the gamer's Date of Birth.");
                //     return;
                // }

                // Parse DOB and calculate age using helper functions
                const dob = parseDobString(dobValue);
                // if (!dob || isNaN(dob.getTime())) {
                //     alert("Please enter DOB in MM-DD-YYYY format.");
                //     return;
                // }
                const age = calcAge(dob);

                // Find "Age of gamer" question and matching option
                const ageQuestion = questionsData.find(q =>
                    q.text.toLowerCase().includes("age of gamer")
                );

               // ✅ Check both conditions first
                if (age > 20 && working_with_attorney === "yes") {
                    showModal(
                        "Age of gamer is more than 20 and you are currently working with an attorney for a gaming sex abuse claim, so you're not eligible.",
                        "error"
                    );
                    setTimeout(() => {
                        window.location.href = "/";
                    }, 15000);
                    return; // Stop further processing
                }

                // ✅ Then check individual conditions
                if (age > 20) {
                    showModal(
                        "Age of gamer is more than 20, so you're not eligible.",
                        "error"
                    );
                    setTimeout(() => {
                        window.location.href = "/";
                    }, 15000);
                    return;
                }

                if (working_with_attorney === "yes") {
                    showModal(
                        "You are currently working with an attorney for a gaming sex abuse claim, so you're not eligible.",
                        "error"
                    );
                    setTimeout(() => {
                        window.location.href = "/";
                    }, 15000);
                    return;
                }

                let matchedOption = null;
                if (ageQuestion) {
                    debugger;
                    ageQuestion.options.forEach(opt => {
                        const text = opt.text.trim();
                        if (text.includes("+")) {
                            const min = parseInt(text);
                            if (age >= min) matchedOption = opt;
                        } else if (text.includes("-")) {
                            const [min, max] = text.split("-").map(Number);
                            if (age >= min && age <= max) matchedOption = opt;
                        }
                    });
                }

                if (!matchedOption) return;

                // if (!matchedOption) {
                //     showModal("No matching age group found for the entered DOB.", "error");
                //     return;
                // }

                // ✅ Step 4: Determine templateType dynamically
                let templateType = "";
                if (!matchedOption.is_eligible) {
                    templateType = "rejected";
                } else if (!matchedOption.requires_parental_signature) {
                    templateType = "eligible_no_parent";
                } else {
                    templateType = "eligible_with_parent";
                }

                // ✅ Step 5: Handle based on eligibility
                if (!matchedOption.is_eligible) {
                    // Send rejection email template
                    $.ajax({
                        url: `/api/email-template/${templateType}/`,
                        type: "GET",
                        success: function (template) {
                            // Replace placeholder with user name
                            const subject = template.subject;
                            const body = template.body.replace("[User First Name]", first_name);

                            // Send rejection email
                            const emailFormData = new FormData();
                            emailFormData.append("from_email", "kumaranyuvaraj007@gmail.com");
                            emailFormData.append("to_email", email);
                            emailFormData.append("subject", subject);
                            emailFormData.append("body", body);

                            $.ajax({
                                url: "/send-email/",
                                type: "POST",
                                data: emailFormData,
                                processData: false,
                                contentType: false,
                                success: function () {
                                    showModal("Age of gamer is more than 20, so you're not eligible.", "error");
                                    // Redirect to thank you page after short delay
                                    setTimeout(() => {
                                       window.location.href = "/";
                                    }, 15000);
                                                },
                                error: function (xhr) {
                                    const err = xhr.responseJSON?.error || "Error sending email.";
                                    showModal("Error: " + err, "error");
                                }
                            });
                        },
                        error: function () {
                            showModal("Could not process request. Please try again.", "error");
                        }
                    });
                } else {
                    // Eligible - proceed to document signing workflow
                    // Proceed with answers submission and document creation
                    submitAnswers(userId, function (redirectUrl) {
                        // After answers are submitted, trigger document creation
                        // This will be handled by the submitAnswers callback
                    });
                }
            },
            error: function (xhr) {
                console.error(xhr.responseJSON);
                alert("Error submitting the form.");
            }
        });
    }

    function showModal(message, type = "info") {
    const iconSources = {
            // success: "{% static 'img/tick.jpg' %}",
            success:"../static/img/tick.jpg",
            error: "{% static 'img/error.jpg' %}",
            info: "{% static 'img/info.jpg' %}"
        };

        $("#modalMessage").text(message);
        $("#modalIcon").attr("src", iconSources[type] || iconSources.info);

        $("#customModal").fadeIn();
        $("#customModal").css("display", "flex");  
    }



    function closeCustomModal() {
    $("#customModal").fadeOut();
    }


    // $("#userForm")[0].reset();
    let questionsData = [];

    /**
     * Check URL parameters for document signing status and show appropriate message
     */
    /**
     * Show document status message banner
     */
    function showDocumentStatusMessage(type, title, message) {        
        const banner = document.getElementById('documentStatusBanner');
        const titleElement = document.getElementById('statusTitle');
        const messageElement = document.getElementById('statusMessage');
        if (!banner || !titleElement || !messageElement) {
            console.error('Required elements not found');
            return;
        }
        
        // Set content
        titleElement.textContent = title;
        messageElement.textContent = message;
        
        // Remove existing type classes and add new one
        banner.className = '';
        banner.classList.add(type);
        
        // Show the banner with animation
        banner.style.display = 'block';
        
        // Use setTimeout to trigger opacity transition after element is shown
        setTimeout(() => {
            banner.style.opacity = '1';
        }, 50);

        // Auto-hide after 15 seconds
        setTimeout(() => {
            banner.style.opacity = '0';
            setTimeout(() => {
                banner.style.display = 'none';
            }, 500);
        }, 15000);
        
        // Smooth scroll to top to ensure user sees the message
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Handle manual close button
        const closeBtn = banner.querySelector('.btn-close');
        if (closeBtn) {
            closeBtn.onclick = function() {
                banner.style.opacity = '0';
                setTimeout(() => {
                    banner.style.display = 'none';
                }, 500);
            };
        }
    }

    $(document).ready(function () {
        // Backend now handles document signing redirects directly

    
        
        $.ajax({
            url: "/api/questions/",
            type: "GET",
            success: function (response) {
                questionsData = response;

                $(".question-dropdown").each(function () {
                    const $select = $(this);
                    const questionText = $select.data("question-text").trim();

                    const matchingQuestion = response.find(q => q.text.trim() === questionText);

                    if (matchingQuestion) {
                        $select.attr("data-question-id", matchingQuestion.id);
                        $select.append(`<option value="">-- Select --</option>`);

                        matchingQuestion.options.forEach(opt => {
                            $select.append(`<option value="${opt.id}">${opt.text}</option>`);
                        });
                    } else {
                        console.warn(`No matching question found for: ${questionText}`);
                    }
                });
            },
            error: function () {
                alert("Failed to load questions.");
            }
        });

        // Remove error-border on input/select change
        $('#screen2 input, #screen2 select').on('input change', function () {
            if ($(this).val().trim()) {
                $(this).removeClass('error-border');
            }
        });

        // $('#consent_checkbox').on('change', function () {
        //     if (this.checked) {
        //         $(this).removeClass('error-border');
        //     }
        // });

        // Auto-format US phone number: 123-456-7890
        $('#cell_phone').on('input', function () {
            let cleaned = $(this).val().replace(/\D/g, ''); // Remove non-digits
            if (cleaned.length > 10) cleaned = cleaned.slice(0, 10); // Limit to 10 digits

            let formatted = cleaned;
            if (cleaned.length > 6) {
                formatted = cleaned.replace(/(\d{3})(\d{3})(\d{1,4})/, '$1-$2-$3');
            } else if (cleaned.length > 3) {
                formatted = cleaned.replace(/(\d{3})(\d{1,3})/, '$1-$2');
            }

            $(this).val(formatted);
        });
        // Auto-format US Zip Code: 12345
        $('#zipcode').on('input', function () {
            let value = $(this).val().replace(/\D/g, ''); // Remove non-digits
            if (value.length > 5) value = value.slice(0, 5); // Limit to 5 digits
            $(this).val(value);
        });
    });







    function submitAnswers(userId, callback) {

    const promises = [];
    const csrf = (typeof getCookie === "function") ? getCookie("csrftoken") : null;

    // --- 1) Prepare DOB → age → age option (dynamic from questionsData) ---
    const dobValue = $("#gamer_dob").val()?.trim();
    let matchedAgeOption = null;  // the Option object chosen for DOB
    let ageQuestion = null;       // the Question object for "Age of gamer?"

    // Find age question from questionsData (once)
    if (Array.isArray(questionsData) && questionsData.length) {
        ageQuestion = questionsData.find(q => (q.text || "").toLowerCase().includes("age of gamer"));
    }

    // Helper to try matching by min_age/max_age if present; otherwise parse "18-20" / "26+"
    function matchOptionByAge(options, age) {
        // Prefer min_age / max_age when provided
        const withRange = options.filter(o => (o.min_age !== undefined && o.min_age !== null) || (o.max_age !== undefined && o.max_age !== null));
        if (withRange.length) {
            for (const opt of withRange) {
                const min = (opt.min_age != null) ? Number(opt.min_age) : -Infinity;
                const max = (opt.max_age != null) ? Number(opt.max_age) : Infinity;
                if (age >= min && age <= max) return opt;
            }
            return null;
        }
        // Fallback: parse text labels
        for (const opt of options) {
            const t = (opt.text || "").trim();
            if (!t) continue;
            if (t.includes("+")) {
                // e.g., "26+"
                const min = parseInt(t, 10);
                if (!isNaN(min) && age >= min) return opt;
            } else if (t.includes("-")) {
                // e.g., "18-20"
                const [minStr, maxStr] = t.split("-").map(s => s.trim());
                const min = parseInt(minStr, 10);
                const max = parseInt(maxStr, 10);
                if (!isNaN(min) && !isNaN(max) && age >= min && age <= max) return opt;
            }
        }
        return null;
    }

    // Compute age & find matching option from DOB (if DOB provided and ageQuestion exists)
    if (dobValue && ageQuestion) {
        const dob = new Date(dobValue);
        if (!isNaN(dob.getTime())) {
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;

            matchedAgeOption = matchOptionByAge(ageQuestion.options || [], age);
            if (!matchedAgeOption) {
                alert("No matching age range found for this date of birth.");
            }
        } else {
            alert("Invalid DOB format. Please use a valid date.");
        }
    }

    // --- 2) Save ALL other dropdown answers (and override age Q with matchedAgeOption if present) ---
    $(".question-dropdown").each(function () {
        const $select = $(this);
        const questionId = Number($select.data("question-id"));
        const selectedOptionId = $select.val();
        const questionText = ($select.data("question-text") || "").trim();

        if (!questionId) return;

        // If this is the Age question, we override with the DOB-matched option (when available).
        if (ageQuestion && questionId === Number(ageQuestion.id)) {
            if (matchedAgeOption && matchedAgeOption.id) {
                const p = $.ajax({
                    url: "/api/answers/submit/",
                    type: "POST",
                    contentType: "application/json",
                    headers: csrf ? { "X-CSRFToken": csrf } : {},
                    data: JSON.stringify({
                        user: userId,
                        question: questionId,
                        selected_option: matchedAgeOption.id
                    })
                }).fail(xhr => {
                    console.error(`Failed to submit age answer for Question ID ${questionId}:`, xhr.responseJSON || xhr.responseText);
                });
                promises.push(p);
            } else {
                // If no match, and user picked a value manually, you may choose to save it;
                // but since you said DOB should drive it, we skip saving the manual selection.
                // If you want to save manual selection as a fallback, uncomment the block below:
                /*
                if (selectedOptionId) {
                    const p = $.ajax({
                        url: "/api/answers/submit/",
                        type: "POST",
                        contentType: "application/json",
                        headers: csrf ? { "X-CSRFToken": csrf } : {},
                        data: JSON.stringify({
                            user: userId,
                            question: questionId,
                            selected_option: selectedOptionId
                        })
                    }).fail(xhr => {
                        console.error(`Failed to submit manual age selection for Question ID ${questionId}:`, xhr.responseJSON || xhr.responseText);
                    });
                    promises.push(p);
                }
                */
            }
            return; // handled age question
        }

        // Normal questions (non-age): save if user selected something
        if (selectedOptionId) {
            const p = $.ajax({
                url: "/api/answers/submit/",
                type: "POST",
                contentType: "application/json",
                headers: csrf ? { "X-CSRFToken": csrf } : {},
                data: JSON.stringify({
                    user: userId,
                    question: questionId,
                    selected_option: selectedOptionId
                })
            }).fail(xhr => {
                console.error(`Failed to submit answer for Question ID ${questionId}:`, xhr.responseJSON || xhr.responseText);
            });
            promises.push(p);
        }
    });

    // If there is no visible "Age of gamer?" dropdown on the page (you removed it),
    // but we still have a matchedAgeOption from DOB, submit it explicitly.
    if (matchedAgeOption && ageQuestion) {
        const alreadyQueued = promises.some(req =>
            // Not trivial to inspect $.ajax object; we’ll assume not duplicated if no dropdown existed.
            false
        );
        if (!alreadyQueued) {
            const p = $.ajax({
                url: "/api/answers/submit/",
                type: "POST",
                contentType: "application/json",
                headers: csrf ? { "X-CSRFToken": csrf } : {},
                data: JSON.stringify({
                    user: userId,
                    question: ageQuestion.id,
                    selected_option: matchedAgeOption.id
                })
            }).fail(xhr => {
                console.error(`Failed to submit DOB-derived age answer for Question ID ${ageQuestion.id}:`, xhr.responseJSON || xhr.responseText);
            });
            promises.push(p);
        }
    }

    // --- 3) After ALL answers saved, apply eligibility logic from the matched age option ---
    $.when.apply($, promises).done(function () {
        // If no DOB or no matched option, we still saved other answers; just stop here
        if (!dobValue) {
            alert("Please enter the gamer's Date of Birth to evaluate eligibility.");
            if (typeof callback === "function") callback(null);
            return;
        }
        if (!ageQuestion) {
            alert("Age question data not found. Please refresh and try again.");
            if (typeof callback === "function") callback(null);
            return;
        }
        if (!matchedAgeOption) {
            // Already alerted earlier that no matching range was found
            if (typeof callback === "function") callback(null);
            return;
        }

        // Use DB flags on the matched option
        
        // Show Modal function integrated with Continue button option
        function showModal(message, withContinueBtn = false) {
            const modal = document.getElementById('customModal');

            // Dynamically update modal content with message and button
            const footer = modal.querySelector('.modal-content');
            footer.innerHTML = `
                <p id="modalMessage">${message}</p>
                ${withContinueBtn
                    ? `<button id="modal-continue-btn" class="btn-blue">Continue</button>` 
                    : `<button class="btn-blue" onclick="closeCustomModal()">OK</button>`}
            `;

            $("#customModal").fadeIn();
        }

        // Main eligibility check and redirection logic
        const ageOptionData = matchedAgeOption;

        if (!ageOptionData.is_eligible) {
            // Redirect to thank-you / gratitude page instead of showing modal
            if (typeof callback === "function") {
                callback(null); // prevent any further redirection from callback
            }
            window.location.href = "/gratitude"; // adjust path if needed
            return;
        }
        if (ageOptionData.requires_parental_signature) {
        // Show modal with "Continue" button
        showModal(
            "Congrats! Your case is potentially eligible for Video Game Sex abuse claim. Please click Continue to next step",
            "success",
            true
        );

        // Attach event AFTER modal is rendered
        setTimeout(() => {
            const continueBtn = document.getElementById("modal-continue-btn");

            if (continueBtn) {
                continueBtn.addEventListener("click", () => {
                    // Show loading spinner
                    const spinnerOverlay = document.getElementById("spinnerOverlay");
                    if (spinnerOverlay) {
                        spinnerOverlay.style.display = "flex";
                    }

                    // Close the modal
                    closeCustomModal();

                        // Create document submission for signing
                        // if (ageOptionData.redirect_to_retainer) {
                        createDocumentSubmission('retainer_agreement', 'eligible_with_parent');
                        // } else if (typeof callback === "function") {
                        //     callback("/retainer-form/");
                        // }
                });
            } else {
                console.error("Continue button not found!");
            }
        }, 200);

    } else {
        // No parental signature needed
        // Show loading spinner
        const spinnerOverlay = document.getElementById("spinnerOverlay");
        if (spinnerOverlay) {
            spinnerOverlay.style.display = "flex";
        }
        
        // if (ageOptionData.redirect_to_retainer) {
        createDocumentSubmission('retainer_agreement', 'eligible_no_parent');
        // } else if (typeof callback === "function") {
        //     callback("/retainer-form/");
        // }
    }

        // // Default: stay on the same page
        // if (typeof callback === "function") callback(null);
    });
}

window.addEventListener("scroll", function () {
        const button = document.getElementById("fixBtnRow");
        const heroSection = document.querySelector(".hero");

        if (window.scrollY > heroSection.offsetHeight) {
            button.classList.add("fixed-btn");
        } else {
            button.classList.remove("fixed-btn");
        }
    });



    // Validate Screen1
    function validateScreen1() {
        let isValid = true;

        // Validate required select fields marked with asterisk in data-question-text
        const selects = document.querySelectorAll("#screen1 .question-dropdown");
        selects.forEach(select => {
        const isRequired = select.dataset.questionText?.includes("*");
        if (isRequired && !select.value) {
            select.classList.add("error-border");
            isValid = false;
        } else {
            select.classList.remove("error-border");
        }
        });

        // Validate Date of Birth
        const dobHiddenInput = document.getElementById("gamer_dob");
        const dobVisibleInput = dobHiddenInput.nextElementSibling; // flatpickr's altInput

        if (!dobHiddenInput.value.trim()) {
        dobVisibleInput.classList.add("error-border");
        isValid = false;
        } else {
        dobVisibleInput.classList.remove("error-border");
        }

        if (isValid) {
        showScreen(2);
        }
    }

    // Remove red border on change or input
    document.addEventListener("DOMContentLoaded", () => {
    const dobHiddenInput = document.getElementById("gamer_dob");
    const dobVisibleInput = dobHiddenInput?.nextElementSibling; // null-safe access

    document.querySelectorAll("#screen1 select, #screen1 input").forEach(el => {
        el.addEventListener("input", () => el.classList.remove("error-border"));
        el.addEventListener("change", () => el.classList.remove("error-border"));
    });

    if (dobHiddenInput) {
        dobHiddenInput.addEventListener("change", () => {
            if (dobHiddenInput.value.trim()) {
                dobVisibleInput?.classList.remove("error-border");
            }
        });
    }
});


    // ====================
    // NextKeySign Integration Functions
    // ====================
    
    /**
     * Create a document submission and redirect to signing URL
     * @param {string} templateType - Type of document template ('retainer_agreement', etc.)
     * @param {string} emailTemplateType - Type of email template to use for custom message ('eligible_no_parent', 'eligible_with_parent')
     */
    function createDocumentSubmission(templateType = 'retainer_agreement', emailTemplateType = null) {
        // Show loading state
        // showModal("Preparing your document for signing...", "info");
        // Get user detail ID from form (you may need to store this differently)
        const userDetailId = getCurrentUserDetailId();
        
        if (!userDetailId) {
            // showModal("Error: User information not found. Please complete the contact details first.", "error");
            return;
        }
        
        // Map template types to DocumentTemplate names in database
        let dbTemplateName = '';
        let finalEmailTemplateType = emailTemplateType; // Use passed parameter if provided
        
        if (templateType === 'retainer_agreement') {
            // Check if parental signature is required based on age
            const dobValue = $("#gamer_dob").val()?.trim();
            if (dobValue) {
                const dob = parseDobString(dobValue);
                if (dob && !isNaN(dob.getTime())) {
                    const age = calcAge(dob);
                    // Under 18 requires parent signature
                    if (age < 18) {
                        dbTemplateName = 'retainer_minor';
                        if (!finalEmailTemplateType) finalEmailTemplateType = 'eligible_with_parent';
                    } else {
                        dbTemplateName = 'retainer_adult';
                        if (!finalEmailTemplateType) finalEmailTemplateType = 'eligible_no_parent';
                    }
                } else {
                    dbTemplateName = 'retainer_minor'; // Default to minor if DOB is invalid
                    if (!finalEmailTemplateType) finalEmailTemplateType = 'eligible_with_parent';
                }
            } else {
                dbTemplateName = 'retainer_minor'; // Default to minor if no DOB
                if (!finalEmailTemplateType) finalEmailTemplateType = 'eligible_with_parent';
            }
        } else {
            dbTemplateName = templateType;
            if (!finalEmailTemplateType) finalEmailTemplateType = 'eligible_no_parent'; // Default
        }
        
        // Prepare API request
        const requestData = {
            user_detail_id: userDetailId,
            template_type: dbTemplateName,
            email_template_type: finalEmailTemplateType
        };

        // Make API call to create document submission
        $.ajax({
            url: '/api/create-document-submission/',
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': csrftoken
            },
            success: function(response) {
                
                // Close current modal
                closeCustomModal();
                
                if (response.submission_url) {
                    // Show success message and redirect
                    // showModal("Document prepared successfully! You will be redirected to sign the retainer agreement.", "success");
                    
                    setTimeout(() => {
                        // Redirect to NextKeySign signing URL
                        window.location.href = response.submission_url;
                    }, 2000);
                } else {
                    showModal("Error: Could not generate signing URL. Please try again.", "error");
                }
            },
            error: function(xhr, status, error) {
                console.error('Error creating document submission:', error);
                console.error('Response:', xhr.responseText);
                
                let errorMessage = "An error occurred while preparing your document.";
                
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                
                showModal(errorMessage, "error");
            }
        });
    }
    
    /**
     * Get current user detail ID
     * This function should return the user_detail_id from the session or form
     * You may need to modify this based on how you store user information
     */
    function getCurrentUserDetailId() {
        // During prequalification flow, get from the most recent submission response
        // This function is called during document creation after user details are submitted
        
        // Option 1: From global variable set during form submission
        if (window.currentUserId) {
            return parseInt(window.currentUserId);
        }
        
        // Option 2: From a hidden form field (if you add one)
        const hiddenField = document.getElementById('user_detail_id');
        if (hiddenField && hiddenField.value) {
            return parseInt(hiddenField.value);
        }
        
        // Option 3: From session storage (fallback for compatibility)
        const sessionId = sessionStorage.getItem('user_detail_id');
        if (sessionId) {
            return parseInt(sessionId);
        }
        
        // If no user detail ID found, user needs to complete contact details first
        console.warn('No user detail ID found. User may need to complete contact details first.');
        return null;
    }


    // Congartulations Popup Script Start

    function showCongrats() {
            const modal = document.getElementById('congratsModal');
            modal.style.display = 'flex';
            
            // Create fireworks
            setTimeout(() => {
                modal.querySelectorAll('.firework').forEach(firework => {
                    firework.style.animation = 'none';
                    void firework.offsetWidth; // Trigger reflow
                    firework.style.animation = 'firework 1s ease-out';
                });
            }, 50);
        }

        function showLoading() {
            document.querySelector('.continue-btn').style.display = 'none';
            const loadingContainer = document.getElementById('loadingContainer');
            const loadingBar = document.getElementById('loadingBar');
            const preparingText = document.getElementById('preparingText');
            
            loadingContainer.style.display = 'block';
            preparingText.style.display = 'block';
            
            setTimeout(() => {
                loadingBar.style.width = '100%';
            }, 100);

            setTimeout(() => {
                // Simulate completion
                // alert('Process complete!');
                location.reload(); // Reset for demo
            }, 2500);
        }
    // Congartulations Popup Script End

    </script>

    <!-- Your form and input elements here -->

<!-- <script>
    document.addEventListener('DOMContentLoaded', function () {
        const dobInput = document.querySelector('#gamer_dob');

        dobInput.addEventListener('blur', function () {
            let raw = this.value.trim().replace(/\D/g, ''); // Remove non-digits

            if (raw.length === 8) {
                let mm = raw.slice(0, 2);
                let dd = raw.slice(2, 4);
                let yyyy = raw.slice(4, 8);

                // Optional: basic range validation
                let isValidDate = !isNaN(new Date(`${yyyy}-${mm}-${dd}`).getTime());
                if (isValidDate) {
                    this.value = `${mm}-${dd}-${yyyy}`;
                } else {
                    alert("Invalid date entered. Please use MMDDYYYY format.");
                    this.value = "";
                }
            }
        });
    });
</script> -->
</body>


    
</html>


<!-- <button id="openModal" class="btn-primary">Yes</button> -->




   