{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Intake Form</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



</head>
  
    <body>
          <!-- <nav class="navbar">
        <div class="nav-content">
            <a href="#" class="logo px-4">Logo Here</a>
            <div class="nav-links">
                <a href="#about">About</a>
                <a href="#cases">Cases</a>
                <a href="#resources">Resources</a>
                <a href="#contact">Contact</a>
            </div>
        </div>
    </nav> -->

    <section class="hero-index">
      
        <a href="#" class="logo d-flex justify-content-left">
            <img src="{% static 'img/theme.svg' %}" alt="Logo" style="width: 260px; height: auto;">
        </a>
        
        <div class="hero-content">
              

            <h1>Kids Hooked on Games? It’s No Accident...</h1>
            <div class="separator"></div>
            <p>gaming companies Use manipulation tactics to keep children glued to their screens</p>

        <div class="sub-heading outer-design"> Does Your Child Game More Than 2 hrs Per Day?</div>
            <div class="row mt-4">
                    <div class=" d-flex justify-content-center">
                    <button class="home-btn" id="openModal" >Yes</button>
                    <button class="home-btn" id="openModal2">No</button>
                </div>
            </div>

        </div>
    </section>

 
    <div class="section-content primary-color">
        <div class="row px-4 py-5">
            <div class="col-12 col-md-6 text-center">
                <img src="{% static 'img/gamer-3.jpg' %}">
            </div>
            <div class="col-12 col-md-6 d-flex flex-column justify-content-center">
      <h4>  85% OF KIDS & TEENS UNDER 18 ARE ADDICTED TO GAMING </h4>
   
      <div><p>That's millions of vulnerable children worldwide whose minds are being exploited by video game companies for profit. <strong>It's time to hold the companies responsible accountable.</strong></p><p></p><p>If your child's gaming habits have spiraled out of control, we can help you take legal action against gaming companies using manipulation tactics to keep children glued to their screens.</p></div>
   
    </div>
</div>
    </div>
    <div class="section-safeguard secondary-color">
        <div class="row px-4 py-5">
             <marquee class="text-center font-large py-3"><h1 style="color: #64ffda;">Life-Altering Issues Caused By Gaming Addiction</h1></marquee>
             
                 <div class="col justify-content-center ">
                       <main class="">
        <div class="content-grid row">
            <div class="content-card-index ">
                <h3 class="text-center">Mental Health</h3>
                <img src="{% static 'img/Mental_Health.jpg' %}" alt="Mental Health">
                <p class="py-4 text-white text-center">ADHD/ADD, anxiety, depression, irritability, psychological distress.</p>
            </div>
            <div class="content-card-index ">
                <h3 class="text-center">Physical Health</h3>
                <img src="{% static 'img/physical.jpg' %}"  alt="Physical">
                <p class="py-4 text-white text-center">Eye strain, repetitive strain injuries, and sedentary lifestyle diseases</p>
            </div>
            <div class="content-card-index ">
                <h3 class="text-center">Daily Life</h3>
                <img src="{% static 'img/daily_life.jpg' %}" alt="Daily Life">
                <p class="py-4 text-white text-center">Escapism, poor school performance, sleep deprivation, and social isolation.</p>
            </div>
             <div class="content-card-index ">
                <h3 class="text-center">Withdrawal Symptoms</h3>
                <img src="{% static 'img/Aggression.jpg' %}" alt="Aggregation">
                <p class="py-4 text-white text-center">Aggression, gamer's rage, and disengagement from daily activities.</p>
            </div>
        </div>
    </main>
                 </div>    
</div>
    </div>

    <div class="section-Lawsuit-index">
        <div class="row px-4 py-5">
            <div class="col-12">
               <div id="" class="text-center">
                <p>Get The Possible Compensation You Deserve</p>
                <h1 class=""><strong>Help Create A Safer Gaming Environment For Children</strong></h1>
                <div class="" data-animation-class=""><div>
                    <p>Gaming companies' neglect of addiction and related injuries demands justice and accountability.</p>
                    <p></p>
                    <p>Our legal team will assess your eligibility for the lawsuit to help secure compensation for your child's professional help.</p>
                </div>
                <button class="" id="openModal3">Click To Sign Up</button>
            </div>
        </div>
            </div>
        </div>

    </div>

    <footer class="footer text-secondary">
        <p>
            DISCLAIMER This website is for informational purposes only. This is a paid legal advertisement. It does not constitute legal advice, and no attorney-client relationship is formed. The accuracy and completeness of the information cannot be guaranteed. Users should consult with an attorney for advice on their specific legal issues. This information does not constitute medical advice and it should not be relied upon as such. Always consult a doctor before changing any medical regimen. We are not responsible for any actions taken based on the information provided on this site. We strive to help you find information to fight for your rights.
        </p>
        <p class="small">All rights reserved Copyright © 2024 Litigation Notification | <a href="privacyandpolicy.html" class="text-secondary">Privacy Policy</a> | <a href="termsandcondition.html" class="text-secondary">Terms & Conditions</a></p>
    </footer>

    <!-- modal popup code -->
      <div class="modal-overlay" id="modal">
        <div class="modal-content scroll">
         <div class="row">
            <div class="col-11"></div>
            <button class="col-1 close-modal" onclick="closeModal()">&times;</button>
            </div>
            <!-- Screen 1 -->
            <div class="form-screen active px-3" id="screen1">
                <div class="mt-3">
                    <label>Within the last 5 weeks, how many hours per day is spent playing Minecraft, Call Of Duty, Fortnite, Roblox or Grand Theft Auto? *</label>
                    <select id="question_5" class="question-dropdown" data-question-text="Within the last 5 weeks, how many hours per day is spent playing Minecraft, Call Of Duty, Fortnite, Roblox or Grand Theft Auto? *"></select>

                </div>
               

                   <div class="mt-3">
                    <label> What harm has the gamer suffered from? *</label>
                    <select id="question_6" class="question-dropdown" data-question-text="What harm has the gamer suffered from? *"></select>
                </div>
                <div class="mt-3">
                    <label>What treatment was received as a result of playing video games? *</label>
                    <select id="question_7" class="question-dropdown" data-question-text="What treatment was received as a result of playing video games? *"></select>

                </div>
                <!-- <div class="mt-3">
                    <label>Age of gamer? *</label>
                    <select id="question_8" class="question-dropdown" data-question-text="Age of gamer? *"></select>

                </div> -->
                <!-- <div class="mt-3">
                    <label>Date of Birth of gamer? *</label>
                    <input type="date" id="gamer_dob" class="form-control" required>
                </div> -->

                <div class="mt-3">
                    <label>Date of Birth of gamer? *</label>
                    <input type="text" id="gamer_dob" class="form-control" placeholder="MM-DD-YYYY" required>
                </div>


                <div class="form-footer">
                    <button type="button" class="btn-primary" onclick="showScreen(2)">Next</button>
                </div>
            </div>

            <!-- Screen 2 -->
            <div class="form-screen px-3" id="screen2">
                <div class="input-group">
                <label>First Name:</label>
                <input type="text" id="first_name" required>
            </div>
            <div class="input-group">
                <label>Last Name:</label>
                <input type="text" id="last_name" required>
            </div>
            <div class="input-group">
                <label>Cell Phone:</label>
                <input type="tel" id="cell_phone" required>
            </div>
            <div class="input-group">
                <label>Email:</label>
                <input type="email" id="email" required>
            </div>
            <div class="input-group">
                <label>Zip Code:</label>
                <input type="text" id="zipcode" required>
            </div>
            <div class="input-group">
                <label>Are you currently working with an attorney for this case?</label>
                <select id="working_with_attorney" required>
                    <option value="">Select</option>
                    <option value="yes">Yes</option>
                    <option value="no">No</option>
                </select>
            </div>
                 <div class="input-group">
                    <label class="form-label">Additional Notes (optional)</label>
                    <input type="text" id="additional_notes">
                </div>
                <div class="input-group d-flex">
                    <div class="d-flex align-items-end gap-1">
                        <input type="checkbox" id="consent_checkbox" class="col-1 check-bx">
                        <label style="font-size: 11px;" class="">
                            By selecting Submit and completing this form I confirm that I am over 18...
                        </label>
                    </div>
                </div>
                <div class="form-footer">
                    <button type="button" class="btn-secondary" onclick="showScreen(1)">Back</button>
                    <button type="button" class="btn-primary" onclick="submitForm()">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- modal popup end -->

 <script>
      // Read CSRF token from the meta tag and add it to every AJAX request
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    document.getElementById('openModal').addEventListener('click', () => {
        document.getElementById('modal').style.display = 'block';
    });

    // Modal Control
    document.getElementById('openModal2').addEventListener('click', () => {
        document.getElementById('modal').style.display = 'block';
    });

    function showScreen(screenNumber) {
        document.querySelectorAll('.form-screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(`screen${screenNumber}`).classList.add('active');
    }

    // ------------------------------
    // Show m-d-Y to the user, submit/store as Y-m-d.
    // maxDate prevents future dates.
    flatpickr("#gamer_dob", {
        altInput: true,
        altFormat: "m-d-Y",   // what the user sees
        dateFormat: "Y-m-d",  // what .val() returns
        maxDate: "today",
        allowInput: true
    });

    function parseDobString(d) {
        if (!d) return null;

        // ISO: 1998-07-30
        if (/^\d{4}-\d{2}-\d{2}$/.test(d)) {
            return new Date(d + "T00:00:00");
        }

        // US: 07-30-1998
        if (/^\d{2}-\d{2}-\d{4}$/.test(d)) {
            const [mm, dd, yyyy] = d.split("-");
            return new Date(`${yyyy}-${mm}-${dd}T00:00:00`);
        }

        return null;
    }

    function calcAge(dob) {
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
        return age;
    }
    // ------------------------------

    function submitForm() {
        const first_name = $("#first_name").val().trim();
        const last_name = $("#last_name").val().trim();
        const cell_phone = $("#cell_phone").val().trim();
        const email = $("#email").val().trim();
        const zipcode = $("#zipcode").val().trim();
        const working_with_attorney = $("#working_with_attorney").val();
        const consent = $("#consent_checkbox").is(":checked");
        const additional_notes = $("#additional_notes").val().trim();

        if (!first_name || !last_name || !cell_phone || !email || !zipcode || !working_with_attorney) {
            alert("Please fill all required fields.");
            return;
        }

        if (!consent) {
            alert("You must agree to the terms before submitting.");
            return;
        }

        const redirectUrl = "/intake-form/";

        // ✅ Step 1: Submit user details
        $.ajax({
            url: "/api/user-details/",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                first_name,
                last_name,
                cell_phone,
                email,
                zipcode,
                working_with_attorney,
                additional_notes
            }),
            success: function (response) {
                const userId = response.id;

                // ✅ Step 2: Store first/last name for prepopulation
                sessionStorage.setItem("guardian_first_name", first_name);
                sessionStorage.setItem("guardian_last_name", last_name);

                // ✅ Step 3: Determine eligibility from DOB
                const dobValue = $("#gamer_dob").val()?.trim();
                if (!dobValue) {
                    alert("Please enter the gamer's Date of Birth.");
                    return;
                }

                // Parse DOB and calculate age using helper functions
                const dob = parseDobString(dobValue);
                if (!dob || isNaN(dob.getTime())) {
                    alert("Please enter DOB in MM-DD-YYYY format.");
                    return;
                }
                const age = calcAge(dob);

                // Find "Age of gamer" question and matching option
                const ageQuestion = questionsData.find(q =>
                    q.text.toLowerCase().includes("age of gamer")
                );

                let matchedOption = null;
                if (ageQuestion) {
                    ageQuestion.options.forEach(opt => {
                        const text = opt.text.trim();
                        if (text.includes("+")) {
                            const min = parseInt(text);
                            if (age >= min) matchedOption = opt;
                        } else if (text.includes("-")) {
                            const [min, max] = text.split("-").map(Number);
                            if (age >= min && age <= max) matchedOption = opt;
                        }
                    });
                }

                if (!matchedOption) {
                    alert("No matching age group found for the entered DOB.");
                    return;
                }

                // ✅ Step 4: Determine templateType dynamically
                let templateType = "";
                if (!matchedOption.is_eligible) {
                    templateType = "rejected";
                } else if (!matchedOption.requires_parental_signature) {
                    templateType = "eligible_no_parent";
                } else {
                    templateType = "eligible_with_parent";
                }

                // ✅ Step 5: Fetch template from backend API
                $.ajax({
                    url: `/api/email-template/${templateType}/`,
                    type: "GET",
                    success: function (template) {
                        // Replace placeholder with user name
                        const subject = template.subject;
                        const body = template.body.replace("[User First Name]", first_name);

                        // ✅ Step 6: Send Email via /send-email/
                        const emailFormData = new FormData();
                        emailFormData.append("from_email", "kumaranyuvaraj007@gmail.com");
                        emailFormData.append("to_email", email);
                        emailFormData.append("subject", subject);
                        emailFormData.append("body", body);

                        $.ajax({
                            url: "/send-email/",
                            type: "POST",
                            data: emailFormData,
                            processData: false,
                            contentType: false,
                            success: function () {
                                // ✅ Step 7: Submit additional answers & redirect if needed
                                submitAnswers(userId, function (redirectUrl) {
                                    if (redirectUrl) {
                                        window.location.href = redirectUrl;
                                    }
                                });
                            },
                            error: function (xhr) {
                                const err = xhr.responseJSON?.error || "Error sending confirmation email.";
                                alert("Submission succeeded but email failed: " + err);
                            }
                        });
                    },
                    error: function () {
                        alert("Could not fetch email template. Please try again.");
                    }
                });
            },
            error: function (xhr) {
                console.error(xhr.responseJSON);
                alert("Error submitting the form.");
            }
        });
    }

    // $("#userForm")[0].reset();
    let questionsData = [];

    $(document).ready(function () {
        $.ajax({
            url: "/api/questions/",
            type: "GET",
            success: function (response) {
                questionsData = response;

                $(".question-dropdown").each(function () {
                    const $select = $(this);
                    const questionText = $select.data("question-text").trim();

                    const matchingQuestion = response.find(q => q.text.trim() === questionText);

                    if (matchingQuestion) {
                        $select.attr("data-question-id", matchingQuestion.id);
                        $select.append(`<option value="">-- Select --</option>`);

                        matchingQuestion.options.forEach(opt => {
                            $select.append(`<option value="${opt.id}">${opt.text}</option>`);
                        });
                    } else {
                        console.warn(`No matching question found for: ${questionText}`);
                    }
                });
            },
            error: function () {
                alert("Failed to load questions.");
            }
        });
    });

function submitAnswers(userId, callback) {
    const promises = [];
    const csrf = (typeof getCookie === "function") ? getCookie("csrftoken") : null;

    // --- 1) Prepare DOB → age → age option (dynamic from questionsData) ---
    const dobValue = $("#gamer_dob").val()?.trim();
    let matchedAgeOption = null;  // the Option object chosen for DOB
    let ageQuestion = null;       // the Question object for "Age of gamer?"

    // Find age question from questionsData (once)
    if (Array.isArray(questionsData) && questionsData.length) {
        ageQuestion = questionsData.find(q => (q.text || "").toLowerCase().includes("age of gamer"));
    }

    // Helper to try matching by min_age/max_age if present; otherwise parse "18-20" / "26+"
    function matchOptionByAge(options, age) {
        // Prefer min_age / max_age when provided
        const withRange = options.filter(o => (o.min_age !== undefined && o.min_age !== null) || (o.max_age !== undefined && o.max_age !== null));
        if (withRange.length) {
            for (const opt of withRange) {
                const min = (opt.min_age != null) ? Number(opt.min_age) : -Infinity;
                const max = (opt.max_age != null) ? Number(opt.max_age) : Infinity;
                if (age >= min && age <= max) return opt;
            }
            return null;
        }
        // Fallback: parse text labels
        for (const opt of options) {
            const t = (opt.text || "").trim();
            if (!t) continue;
            if (t.includes("+")) {
                // e.g., "26+"
                const min = parseInt(t, 10);
                if (!isNaN(min) && age >= min) return opt;
            } else if (t.includes("-")) {
                // e.g., "18-20"
                const [minStr, maxStr] = t.split("-").map(s => s.trim());
                const min = parseInt(minStr, 10);
                const max = parseInt(maxStr, 10);
                if (!isNaN(min) && !isNaN(max) && age >= min && age <= max) return opt;
            }
        }
        return null;
    }

    // Compute age & find matching option from DOB (if DOB provided and ageQuestion exists)
    if (dobValue && ageQuestion) {
        const dob = new Date(dobValue);
        if (!isNaN(dob.getTime())) {
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;

            matchedAgeOption = matchOptionByAge(ageQuestion.options || [], age);
            if (!matchedAgeOption) {
                alert("No matching age range found for this date of birth.");
            }
        } else {
            alert("Invalid DOB format. Please use a valid date.");
        }
    }

    // --- 2) Save ALL other dropdown answers (and override age Q with matchedAgeOption if present) ---
    $(".question-dropdown").each(function () {
        const $select = $(this);
        const questionId = Number($select.data("question-id"));
        const selectedOptionId = $select.val();
        const questionText = ($select.data("question-text") || "").trim();

        if (!questionId) return;

        // If this is the Age question, we override with the DOB-matched option (when available).
        if (ageQuestion && questionId === Number(ageQuestion.id)) {
            if (matchedAgeOption && matchedAgeOption.id) {
                const p = $.ajax({
                    url: "/api/answers/submit/",
                    type: "POST",
                    contentType: "application/json",
                    headers: csrf ? { "X-CSRFToken": csrf } : {},
                    data: JSON.stringify({
                        user: userId,
                        question: questionId,
                        selected_option: matchedAgeOption.id
                    })
                }).fail(xhr => {
                    console.error(`Failed to submit age answer for Question ID ${questionId}:`, xhr.responseJSON || xhr.responseText);
                });
                promises.push(p);
            } else {
                // If no match, and user picked a value manually, you may choose to save it;
                // but since you said DOB should drive it, we skip saving the manual selection.
                // If you want to save manual selection as a fallback, uncomment the block below:
                /*
                if (selectedOptionId) {
                    const p = $.ajax({
                        url: "/api/answers/submit/",
                        type: "POST",
                        contentType: "application/json",
                        headers: csrf ? { "X-CSRFToken": csrf } : {},
                        data: JSON.stringify({
                            user: userId,
                            question: questionId,
                            selected_option: selectedOptionId
                        })
                    }).fail(xhr => {
                        console.error(`Failed to submit manual age selection for Question ID ${questionId}:`, xhr.responseJSON || xhr.responseText);
                    });
                    promises.push(p);
                }
                */
            }
            return; // handled age question
        }

        // Normal questions (non-age): save if user selected something
        if (selectedOptionId) {
            const p = $.ajax({
                url: "/api/answers/submit/",
                type: "POST",
                contentType: "application/json",
                headers: csrf ? { "X-CSRFToken": csrf } : {},
                data: JSON.stringify({
                    user: userId,
                    question: questionId,
                    selected_option: selectedOptionId
                })
            }).fail(xhr => {
                console.error(`Failed to submit answer for Question ID ${questionId}:`, xhr.responseJSON || xhr.responseText);
            });
            promises.push(p);
        }
    });

    // If there is no visible "Age of gamer?" dropdown on the page (you removed it),
    // but we still have a matchedAgeOption from DOB, submit it explicitly.
    if (matchedAgeOption && ageQuestion) {
        const alreadyQueued = promises.some(req =>
            // Not trivial to inspect $.ajax object; we’ll assume not duplicated if no dropdown existed.
            false
        );
        if (!alreadyQueued) {
            const p = $.ajax({
                url: "/api/answers/submit/",
                type: "POST",
                contentType: "application/json",
                headers: csrf ? { "X-CSRFToken": csrf } : {},
                data: JSON.stringify({
                    user: userId,
                    question: ageQuestion.id,
                    selected_option: matchedAgeOption.id
                })
            }).fail(xhr => {
                console.error(`Failed to submit DOB-derived age answer for Question ID ${ageQuestion.id}:`, xhr.responseJSON || xhr.responseText);
            });
            promises.push(p);
        }
    }

    // --- 3) After ALL answers saved, apply eligibility logic from the matched age option ---
    $.when.apply($, promises).done(function () {
        // If no DOB or no matched option, we still saved other answers; just stop here
        if (!dobValue) {
            alert("Please enter the gamer's Date of Birth to evaluate eligibility.");
            if (typeof callback === "function") callback(null);
            return;
        }
        if (!ageQuestion) {
            alert("Age question data not found. Please refresh and try again.");
            if (typeof callback === "function") callback(null);
            return;
        }
        if (!matchedAgeOption) {
            // Already alerted earlier that no matching range was found
            if (typeof callback === "function") callback(null);
            return;
        }

        // Use DB flags on the matched option
        const ageOptionData = matchedAgeOption;
        if (!ageOptionData.is_eligible) {
            alert("Thank you for your interest.Based on the information provided, your case does not currently meet the eligibility criteria for a Roblox minor gamer claim.We appreciate your time. If circumstances change, feel free to revisit this form.");
            if (typeof callback === "function") callback(null);
            return;
        }

        if (ageOptionData.requires_parental_signature) {
            alert("Thank you for answering the prequalification questions.Based on your responses, your case appears to be eligible for a Roblox minor gamer claim.Please click below to continue and complete the retainer form.");
        } else {
            alert("You are eligible for the retainer form.");
        }

        if (ageOptionData.redirect_to_retainer) {
            if (typeof callback === "function") {
                callback("/retainer-form/");
                return;
            }
        }

        // Default: stay on the same page
        if (typeof callback === "function") callback(null);
    });
}


    </script>


    </body>
</html>


<!-- <button id="openModal" class="btn-primary">Yes</button> -->

   

   